<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="images/logo.png" type="image/png">
    <style>
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message-content code {
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        .spinner {
        border: 4px solid #f3f3f3; /* Light gray */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 24px; /* Tama√±o del spinner */
        height: 24px;
        animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
     <!-- Navbar -->
     <div class="bg-white shadow-md">
        <div class="container mx-auto flex items-center justify-between p-4">
            <!-- Logo -->
            <div class="flex items-center space-x-2">
                <div class="bg-gray-800 text-white rounded-full w-8 h-8 flex items-center justify-center">
                    <span class="font-bold text-lg">ü§ñ</span>
                </div>
                <span class="text-xl font-bold text-gray-800">ChatBot</span>
            </div>

            <!-- Navigation Links -->
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-gray-800">Home</a>
                <a href="about.html" class="text-gray-600 hover:text-gray-800">About us</a>
                <a href="auth.html#login" id = "login-btn" class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200">Sign in</a>
                <a href="auth.html#register" id = "register-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Register</a>
                <button id="profile-btn" class="hidden bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-semibold flex items-center space-x-2 hover:bg-blue-200"></button>
                    <span id="profile-username"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.485 0 4.797.657 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <button id="logout-btn" class="ml-2 bg-red-200 text-red-700 px-2 py-1 rounded hover:bg-red-300">Logout</button>
                </button>
            </div>
        </div>
    </div>
<div class="container mx-auto p-4 flex-1 flex flex-col">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">USB AI</h1>

    <div class="flex-1 overflow-y-auto mb-4 p-4 bg-white rounded-lg shadow">
        <div id="chat-messages" class="space-y-4"></div>
    </div>

    <form id="chat-form" class="flex items-center">
        <input
                type="text"
                id="message-input"
                name="message"
                placeholder="Type your message..."
                class="flex-1 p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
        >
        <button
                type="submit"
                id = "send-button"
                class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
            Send
        </button>
        <button
                type="button"
                id = "stop-button"
                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 hidden"
        >
            Stop
        </button>
    </form>
</div>
<script>
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const chatMessages = document.getElementById('chat-messages');

    let isProcessing = false;
    let abortController = null;
    let reader = null;
    let currentRequestID = null;

    // Recuperar usuario desde localStorage
    let currentUser = { username: "User" };
    try {
        const userData = localStorage.getItem('user');
        if (userData) {
            currentUser = JSON.parse(userData);
        }
    } catch (e) {
        // Si hay error, se queda como "User"
    }
    window.addEventListener('DOMContentLoaded', () => {
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileUsername = document.getElementById('profile-username');
        const logoutBtn = document.getElementById('logout-btn');
        let currentUser = null;

        try {
        const userData = localStorage.getItem('user');
        if (userData) {
            currentUser = JSON.parse(userData);
            }
        } catch (e) {}

        if (currentUser && currentUser.username) {
            if (loginBtn) loginBtn.style.display = 'none';
            if (registerBtn) registerBtn.style.display = 'none';
            if (profileBtn) {
                profileBtn.classList.remove('hidden');
                profileUsername.textContent = currentUser.username;
            }
        } 
        else {
            if (loginBtn) loginBtn.style.display = '';
            if (registerBtn) registerBtn.style.display = '';
            if (profileBtn) profileBtn.classList.add('hidden');
            if(logoutBtn) logoutBtn.style.display = 'none';
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function(e) {
                e.stopPropagation();
                await fetch('/logout', { method: 'POST' });
                localStorage.removeItem('user');
                window.location.href = "auth.html#login";
            });
        }
    });


    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Si hay una solicitud en proceso, no hacer nada
        if (isProcessing) {
            console.warn('Ya hay una solicitud en proceso. Por favor, espera o det√©n la respuesta actual.');
            return;
        }

        const message = messageInput.value;
        if (!message) return;

        // Crear un nuevo controlador de aborto
        abortController = new AbortController();
        const signal = abortController.signal;

        // Add user message to chat
        addMessageToChat('User', message);

        // Clear input
        messageInput.value = '';

        // Actualizar UI
        messageInput.disabled = true;
        sendButton.disabled = true;
        stopButton.classList.remove('hidden');

        let botMessageElement = addMessageToChat('Bot', '<div class="spinner"></div>');
        let contentElement = botMessageElement.querySelector('.message-content');
        
        const userData = localStorage.getItem('user');
        let carrera = '';
        let materias = [];
        let username = '';
        if (userData) {
            const user = JSON.parse(userData);
            carrera = user.carrera || '';
            materias = user.materias || [];
            username = user.username || '';
        }
        const payload = { message, carrera, materias, username };


        // Fetch streaming data from the server
        try {
            isProcessing = true;

            // IMPORTANTE: Pasar el signal como par√°metro separado, no concatenado al URL
            //const response = await fetchStreamWithRetry('/stream?message=' + encodeURIComponent(message), signal );
            
            const response = await fetch('/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                signal
            });
            reader = response.body.getReader();
            contentElement.innerHTML = ''; // Clean the Spinner
            
            await processStream(reader, contentElement);
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('Solicitud cancelada');
                contentElement.innerHTML += '\n[Respuesta cancelada]';
            } else {
                console.error('Error al obtener la respuesta del chatbot:', error);
                addMessageToChat('System', 'Se ha producido un error al obtener la respuesta. Por favor, int√©ntelo de nuevo.');
            }
        } finally { 
            // Limpiar estado
            isProcessing = false;
            abortController = null;
            reader = null;
            
            // Restaurar UI
            messageInput.disabled = false;
            sendButton.disabled = false;
            stopButton.classList.add('hidden');
            messageInput.focus();
        }
    });

    stopButton.addEventListener('click', async function () {
        if (!isProcessing) return;
        
        // Cancelar la solicitud HTTP
        if (abortController) {
            abortController.abort();
        }
        
        // Limpieza adicional
        if (reader) {
            try {
                await reader.cancel();
            } catch (error) {
                console.warn('Error al cancelar el lector:', error);
            }
        }
        fetch('/clear-memory', { method: 'POST' });
    });

    async function processStream(reader, contentElement) {
        const decoder = new TextDecoder("utf-8");
        try {
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                contentElement.innerHTML += decoder.decode(value, { stream: true });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('El flujo fue interrumpido.');
            } else {
                console.error('Error procesando el flujo:', error);
                contentElement.innerHTML += '<br>[Error: Stream interrupted.]';
            }
            throw error; // Re-lanzar para que se maneje en el bloque superior
        }
    }

    function addMessageToChat(sender, content) {
        let displayName = sender;
        if(sender == 'User' && currentUser && currentUser.username){
            displayName = currentUser.username;
        }
        
        const messageElement = document.createElement('div');
        messageElement.className = `${sender.toLowerCase()}-message ${sender === 'User' ? 'bg-blue-100' : 'bg-gray-100'} p-3 rounded-lg flex items-start space-x-2`;

        // Escapar caracteres especiales en el contenido
        const escapedContent = content ? content.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';

        messageElement.innerHTML = `
            <div class="flex-1">
                <div class="font-bold ${sender === 'User' ? 'text-blue-600' : 'text-green-600'}">${displayName}:</div>
                <div class="message-content">${content || '...'}</div>
            </div>
            ${sender === 'Bot' && content && !content.includes('<div class="spinner"></div>') ? `
            <button
                class="speak-button bg-gray-200 text-gray-600 p-2 rounded-full hover:bg-gray-300 focus:outline-none"
                onclick="speakWithBackend('${escapedContent}')"
                title="Speak"
            >
                üîä
            </button>` : ''}
        `;

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageElement;
    }
    async function fetchStreamWithRetry(url, signal, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, { signal });
            if (!response.ok) {
                console.error(`HTTP error! status: ${response.status}`);
                const errorText = await response.text();
                console.error('Error details:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response;
        } catch (e) {
            if(e.name == 'AbortError') throw e;
            console.error(`Attempt ${i + 1} failed: ${e.message}`);
            if (i === retries - 1) throw e;
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second before retrying
        }
    }
}

</script>
<script>    
    function speakWithBackend(text) {
        fetch('/speak', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text }),
        }).then(response => {
            if (!response.ok) {
                console.error('Error al enviar el texto al backend para hablar.');
            }
        }).catch(error => {
            console.error('Error en la solicitud al backend:', error);
        });
    }
</script>
</body>
</html>
